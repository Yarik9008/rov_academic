# Архитектура комплекса ТНПА 
## Схема взаимодействия
```
Пульт управления:
[Геймпад] → [STM32 Gamepad] → [RS-422] → [Кабель-связка]

Робот:
[Кабель-связка] → [RS-422] → [STM32 ROV] → [Моторы + Полезная нагрузка]
                                 ↑
                         [IMU + Depth Sensor]
```

### 1. Пульт управления (rov_gamepad)
- **Назначение:** Удаленное управление ТНПА через
- **Микроконтроллер:** STM32F103C8T6
- **Операторский интерфейс:** 2 джойстика + 8 кнопок
- **Питание:** DC от 12 до 36 вольт 
- **Связь:** RS-422 (дуплексная помехозащищенная)
- **Выходные данные:** Пакет из 11 параметров: 6 осей + 3 команды для полезной нагрузки + 2 режима

#### Структура пакета joystick_data
```
linear_x linear_y linear_z rotate_x rotate_y rotate_z servo_cam gripper led auto_depth auto_stabilize
```
#### Формат передачи
- **Протокол:** Serial UART (115200 baud)
- **Формат:** ASCII текст, разделитель - символ переноса строки (\n)
- **Частота:** 20 Гц (50 мс интервал)

**Пример:** `50 0 0 25 0 0 0 1 1 0 1`

### Параметры
- **linear_x** int (-100 до 100) - движение вперед/назад
- **linear_y** int (-100 до 100) - движение вверх/вниз  
- **linear_z** (-100 до 100) - резервная ось
- **rotate_x** (-100 до 100) - поворот влево/вправо
- **rotate_y** (-100 до 100) - резервная ось поворота
- **rotate_z** (-100 до 100) - резервная ось поворота
- **servo_cam** (-1, 0, 1) - команда камеры
- **gripper** (-1, 0, 1) - команда манипулятора
- **led** (-1, 0, 1) - команда освещения
- **auto_depth** (0, 1) - включение автоглубины
- **auto_stabilize** (0, 1) - включение автостабилизации


### 2. Система управления ТНПА (rov_control_system)
**Назначение:** Получение команд управления с пульта, управление полезной назрузкой, сбор телеметрии, стабилизация 
- **Микроконтроллер:** STM32 (блок электроники на роботе)
- **Датчики:** IMU (BMO085) + датчик глубины (MS5837)
- **Алгоритм:** PID контроллеры для стабилизации по 6 осям
  - **Roll PID** - стабилизация крена (наклон влево/вправо)
  - **Pitch PID** - стабилизация тангажа (наклон вперед/назад) 
  - **Yaw PID** - стабилизация рыскания (поворот влево/вправо)
  - **Depth PID** - стабилизация глубины (движение вверх/вниз)
  - **Forward PID** - стабилизация линейного положения вперед/назад
  - **Lateral PID** - стабилизация бокового положения влево/вправо
- **Полезная нагрузка:** 
  - **Движители:** 4 мотора (2 вертикальных + 2 горизонтальных)
  - **Камера:** сервопривод управляемый ШИМ-регулированием
  - **Манипулятор:** захват управляемый ШИМ-регулированием
  - **Освещение:** подводные светодиоды с ШИМ-регулированием
  - **Датчики:** IMU (BMO085) + датчик глубины (MS5837)



## Схема питания

### Схема распределения питания
```
[AC 220V] → [Пост управления] → [Блок питания 36V] → [Кабель-связка] → [Робот]
                                    ↓
                              [DC-DC 5V] → [STM32 + Датчики]
                                    ↓
                              [DC-DC 3.3V] → [Логика]
                                    ↓
                              [Моторы + Сервоприводы]

[AC 220V] → [Пост управления] → [Блок питания 12V] → [Кабель-связка] → [Экран камеры]
```

### Пульт управления
- **Входное питание:** DC 36V (от поста управления)
- **Стабилизация:** DC-DC преобразователь 5V/3.3V

### Пост управления
- **Первичное питание:** AC 220V (сеть)
- **Блок питания 36V:** для робота и пульта управления
- **Блок питания 12V:** для экрана камеры
- **Распределение:** по кабель-связке на робота

### Робот
- **Входное питание:** DC 36V (кабель-связка)
- **Понижающий преобразователь:** DC-DC преобразователь с 36V на 12V-15V 
- **Понижающий преобразователь логики :** изолированный DC-DC преобразователь с 12V-24V на 5V/3.3V
- **Понижающий преобразователь камеры :** DC-DC преобразователь с 12V-24V на 12V
- **Понижающий преобразователь сервопривода камеры** DC-DC преобразователь с 12V-24V на 5V
Опционально 
- **Понижающий преобразователь манипулятора** DC-DC преобразователь с 12V-24V на 12V



## Алгоритм стабилизации PID

### Принцип работы
Система использует 6 независимых PID контроллеров для стабилизации ТНПА по осям ориентации, глубины и линейного положения.

### Распределение по осям
- **Roll PID** - управляет вертикальными моторами (левый/правый) для компенсации крена
- **Pitch PID** - резерв (ограничен конфигурацией моторов)
- **Yaw PID** - управляет горизонтальными моторами (левый/правый) для компенсации рыскания  
- **Depth PID** - управляет вертикальными моторами синхронно для удержания глубины
- **Forward PID** - управляет горизонтальными моторами синхронно для удержания позиции вперед/назад
- **Lateral PID** - резерв (требует дополнительных моторов для бокового движения)

### Управление полезной нагрузкой
- **Camera Control** - управление сервоприводом камеры (поворот вверх/вниз)
- **Manipulator Control** - управление захватом манипулятора (открыть/закрыть)
- **Lighting Control** - управление подводным освещением (включить/выключить)
- **Payload Stabilization** - стабилизация полезной нагрузки относительно корпуса ТНПА

### Алгоритм работы
1. **Сбор данных** - получение текущих значений от датчиков (IMU, глубина)
2. **Обработка команд** - интерпретация команд с пульта управления
3. **Расчет ошибки** - сравнение текущих значений с целевыми
4. **PID расчет** - вычисление корректирующих команд для моторов
5. **Управление нагрузкой** - обработка команд полезной нагрузки
6. **Распределение команд** - применение к моторам и сервоприводам
7. **Ограничения** - проверка безопасных пределов и валидация
8. **Телеметрия** - отправка состояния системы на пульт

### Режимы работы
- **Manual** - ручное управление без стабилизации
- **Stabilize** - автоматическая стабилизация по всем осям
- **Hold** - удержание текущей позиции/ориентации

## Управление полезной нагрузкой

### Камера
- **Тип управления:** Сервопривод с обратной связью
- **Диапазон:** Поворот вверх/вниз относительно корпуса
- **Команды:** -1 (вниз), 0 (нейтраль), 1 (вверх)
- **Стабилизация:** Компенсация наклона корпуса для стабильного изображения

### Манипулятор
- **Тип управления:** Сервопривод захвата
- **Режимы:** Открыт/Закрыт
- **Команды:** -1 (открыть), 0 (нейтраль), 1 (закрыть)
- **Безопасность:** Автоматическое освобождение при потере связи

### Освещение
- **Тип управления:** ШИМ-регулирование яркости
- **Режимы:** Выключено/Включено
- **Команды:** -1 (выключить), 0 (нейтраль), 1 (включить)
- **Защита:** Ограничение тока и температуры

### Координация систем
- **Синхронизация:** Согласованная работа всех систем
- **Приоритеты:** Безопасность > Стабилизация > Полезная нагрузка
- **Мониторинг:** Контроль состояния всех подсистем
- **Диагностика:** Автоматическое обнаружение неисправностей





## Распиновка платы джойстика

### Горизонтальная схема расположения контактов

```
┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
│  1  │  2  │  3  │  4  │  5  │  6  │  7  │  8  │  9  │ 10  │ 11  │ 12  │ 13  │ 14  │ 15  │ 16  │ 17  │ 18  │ 19  │ 20  │ 21  │ 22  │ 23  │ 24  │
├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤
│BTN1 │BTN2 │BTN3 │BTN4 │ GND │J1_X │J1_Y │+3.3 │ GND │ VCC │ GND │TX+  │TX-  │RX+  │RX-  │ GND │+3.3 │J2_X │J2_Y │ GND │BTN5 │BTN6 │BTN7 │BTN8 │
└─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘
```

### Описание контактов

| Пин | Название | Назначение |
|-----|----------|------------|
| 1   | BTN1     | Кнопка 1 (цифровой вход) |
| 2   | BTN2     | Кнопка 2 (цифровой вход) |
| 3   | BTN3     | Кнопка 3 (цифровой вход) |
| 4   | BTN4     | Кнопка 4 (цифровой вход) |
| 5   | GND      | Общий провод кнопок |
| 6   | J1_X     | Ось X первого джойстика (ADC) |
| 7   | J1_Y     | Ось Y первого джойстика (ADC) |
| 8   | +3.3     | Общий плюс джойстика |
| 9   | GND      | Общий минус джойстика |
| 10  | VCC      | Плюс питания (12-36V) |
| 11  | GND      | Минус питания |
| 12  | TX+      | Передача данных RS-422 (положительный) |
| 13  | TX-      | Передача данных RS-422 (отрицательный) |
| 14  | RX+      | Прием данных RS-422 (положительный) |
| 15  | RX-      | Прием данных RS-422 (отрицательный) |
| 16  | GND      | Общий минус джойстика |
| 17  | +3.3     | Общий плюс джойстика |
| 18  | J2_X     | Ось X второго джойстика (ADC) |
| 19  | J2_Y     | Ось Y второго джойстика (ADC) |
| 20  | GND      | Общий провод кнопок |
| 21  | BTN5     | Кнопка 5 (цифровой вход) |
| 22  | BTN6     | Кнопка 6 (цифровой вход) |
| 23  | BTN7     | Кнопка 7 (цифровой вход) |
| 24  | BTN8     | Кнопка 8 (цифровой вход) |
